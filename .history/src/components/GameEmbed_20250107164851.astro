---
import { Image } from "astro:assets";
import gamePreview from "/src/assets/FiddleBops.webp";
---

<section id="play-fiddlebops" class="h-full flex flex-col justify-center">
  <h2 class="text-2xl sm:text-3xl font-bold font-display text-secondary mb-4 sm:mb-8 text-center">
    立即畅玩
  </h2>
  <div class="relative w-full max-w-4xl mx-auto px-2 sm:px-4">
    <div
      id="iframe-placeholder"
      class="absolute inset-0 flex justify-center items-center z-10 transition-opacity duration-300 px-4 md:px-0"
    >
      <div class="absolute inset-0 backdrop-blur-sm">
        <Image
          src={gamePreview}
          alt="FiddleBops 游戏预览"
          loading="eager"
          width={800}
          height={600}
          class="w-full h-full object-contain"
          format="webp"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-primary/80 via-background/50 to-background/80 backdrop-blur-sm md:backdrop-blur-none">
        </div>
      </div>
      <button
        id="play-button"
        class="relative z-20 bg-accent hover:bg-accent-dark text-text-light font-bold py-3 px-6 sm:py-4 sm:px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 text-base sm:text-lg"
      >
        开始游戏
        <div id="loading-indicator" class="hidden">
          <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
          </svg>
        </div>
      </button>
    </div>
    <div id="iframe-container" class="relative">
      <iframe
        id="fiddlebops-iframe"
        data-src="https://silkycell.github.io/FiddleBops/"
        title="FiddleBops Game"
        allowfullscreen
        loading="lazy"
        class="w-full aspect-video border-4 border-primary rounded-lg shadow-xl md:aspect-[4/3] lg:aspect-video"
      ></iframe>
    </div>
  </div>
</section>

<style>
  @keyframes pulse {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
    }
    50% {
      box-shadow: 0 0 0 15px rgba(255, 255, 255, 0);
    }
  }

  .pulse-animation {
    animation: pulse 2s infinite;
  }
</style>

<script>
  // 动态创建提示条
  function createOrientationNotice() {
    const notice = document.createElement('div');
    notice.id = 'orientation-notice';
    notice.className = 'w-full bg-accent/90 text-text-light py-2 px-4 transform transition-transform duration-300 flex justify-between items-center backdrop-blur-sm -translate-y-full';
    notice.innerHTML = `
      <p class="text-xs sm:text-sm md:text-base flex items-center justify-between w-full">
        建议将设备横置以获得最佳游戏体验
        <button class="ml-2 underline hover:text-white whitespace-nowrap" id="rotate-device">
          立即横屏
        </button>
      </p>
      <button class="text-sm hover:text-white" id="close-notice" aria-label="关闭提示">
        <i class="fas fa-times"></i>
      </button>
    `;
    const headerContainer = document.querySelector('header');
    if (headerContainer) {
      headerContainer.insertAdjacentElement('beforebegin', notice);
    }
    return notice;
  }

  let isLoading = false;

  const playButton = document.getElementById("play-button");
  const iframePlaceholder = document.getElementById("iframe-placeholder");
  const fiddlebopsIframe = document.getElementById("fiddlebops-iframe");
  const loadingIndicator = document.getElementById("loading-indicator");

  function setLoading(loading: boolean) {
    isLoading = loading;
    loadingIndicator?.classList.toggle("hidden", !loading);
  }

  playButton?.addEventListener("click", async () => {
    if (isLoading || !fiddlebopsIframe || !iframePlaceholder) return;
    
    try {
      setLoading(true);
      iframePlaceholder.style.opacity = "0";
      iframePlaceholder.style.pointerEvents = "none";

      const dataSrc = (fiddlebopsIframe as HTMLIFrameElement).dataset.src;
      if (!dataSrc) throw new Error("游戏源地址未设置");

      const timeout = setTimeout(() => {
        if (!fiddlebopsIframe.hasAttribute("data-loaded")) {
          throw new Error("游戏加载超时，请检查网络连接");
        }
      }, 30000);

      (fiddlebopsIframe as HTMLIFrameElement).src = dataSrc;
      
      fiddlebopsIframe.addEventListener("load", () => {
        clearTimeout(timeout);
        setLoading(false);
        fiddlebopsIframe.setAttribute("data-loaded", "true");
        fiddlebopsIframe.focus();
      });

      fiddlebopsIframe.addEventListener("error", () => {
        clearTimeout(timeout);
        throw new Error("游戏加载失败，请检查网络连接");
      });

    } catch (error) {
      setLoading(false);
      iframePlaceholder.style.opacity = "1";
      iframePlaceholder.style.pointerEvents = "auto";
      alert(error instanceof Error ? error.message : "加载失败，请重试");
    }
  });

  function checkOrientation() {
    // 检查是否是移动设备
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    console.log('Is Mobile:', isMobile);
    console.log('Window Size:', window.innerWidth, window.innerHeight);
    console.log('User Agent:', navigator.userAgent);
    
    if (isMobile && window.innerHeight > window.innerWidth) {
      console.log('Should show notice');
      const notice = document.getElementById('orientation-notice');
      if (notice) {
        notice.style.transform = 'translateY(0)';
      }
    } else {
      console.log('Should hide notice');
      const notice = document.getElementById('orientation-notice');
      if (notice) {
        notice.style.transform = 'translateY(-100%)';
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      createOrientationNotice();
      setTimeout(() => {
        const closeNotice = document.getElementById('close-notice');
        const rotateDevice = document.getElementById('rotate-device');
        
        closeNotice?.addEventListener('click', () => {
          const notice = document.getElementById('orientation-notice');
          if (notice) {
            notice.style.transform = 'translateY(-100%)';
          }
        });

        // 横屏按钮
        rotateDevice?.addEventListener('click', () => {
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          }
          if ('orientation' in screen && 'lock' in (screen.orientation as any)) {
            (screen.orientation as any).lock('landscape').catch(() => {
              // 如果不支持锁定方向，静默失败
            });
          }
        });

        checkOrientation();
        window.addEventListener('resize', checkOrientation);
      }, 0);
    }
  });
</script> 