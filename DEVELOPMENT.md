# Landing Page 项目开发文档

## ⚠️ 重要说明

本项目是基于 iframe 嵌入 H5 游戏的落地页：

- 游戏本身是独立的 H5 应用，通过 iframe 嵌入
- 游戏控制和交互由游戏内部实现
- 我们的组件主要负责游戏容器管理和外围功能
- 避免干扰游戏内部的控制和交互机制

## 目录

1. [技术栈](#技术栈)
2. [核心原则](#核心原则)
3. [开发环境设置](#开发环境设置)
4. [项目优化指南](#项目优化指南)
5. [Mobile-First 思维优化](#mobile-first-思维优化)
6. [性能优化](#性能优化)
7. [测试和监控](#测试和监控)
8. [项目结构](#项目结构)

## 技术栈

- **框架**: Astro
- **样式**: Tailwind CSS
- **语言**: TypeScript
- **包管理器**: pnpm

## 核心原则

### 静态生成原则

- 充分利用 Astro 的静态站点生成（SSG）能力
- 在构建时生成所有页面内容
- 避免不必要的客户端 JavaScript
- 优先考虑静态解决方案
- **关键实践**:
  1. 所有页面内容在构建时生成
  2. 避免运行时的动态数据加载
  3. 合理使用部分水合（Partial Hydration）
  4. 保持最小化的客户端交互

### 最小必要原则

- 每个阶段只实现最小必要的功能
- 避免过度设计和冗余功能
- 持续评估每个功能的必要性
- **重要**: 所有优化都不得影响现有样式和前端展现

### 渐进式优化原则

- 采用稳妥的方式，逐步进行修改
- 每次修改保持向后兼容
- 在引入新特性时保留旧的实现
- 分阶段验证和迭代
- **关键步骤**:
  1. 创建新的实现但不启用
  2. 完整测试新实现
  3. 渐进式替换旧实现
  4. 保留回退方案
  5. 全面验证后移除旧实现

#### 实践指导

1. **代码组织**

   - 新旧实现并存时使用清晰的命名区分
   - 通过配置开关控制功能切换
   - 保持良好的代码组织和文档说明

2. **测试策略**

   - 为新实现编写完整的测试用例
   - 确保新旧实现的测试覆盖率
   - 添加集成测试验证兼容性

3. **部署策略**

   - 使用特性开关控制新功能发布
   - 实现灰度发布机制
   - 准备回滚方案

4. **监控和反馈**

   - 实现详细的日志记录
   - 添加性能监控指标
   - 收集用户反馈数据

5. **风险控制**
   - 评估每个变更的影响范围
   - 制定应急预案
   - 建立快速响应机制

#### 示例：国际化优化

以下是一个渐进式优化的具体示例，展示如何安全地改进国际化实现：

1. **第一阶段：重构准备**

   ```typescript
   // 1. 将翻译文件拆分到独立模块
   src/i18n/translations/
     ├── en.ts
     └── zh.ts

   // 2. 保持原有的同步加载机制
   export const ui = {
     en,
     zh,
   } as const;
   ```

2. **第二阶段：新旧并存**

   ```typescript
   // 1. 添加新的异步加载机制
   async function loadTranslation(lang: string) {
     // 新实现
   }

   // 2. 保留旧的同步实现
   const ui = {
     /*...*/
   };

   // 3. 通过配置控制
   const USE_ASYNC = false;
   ```

3. **第三阶段：渐进切换**

   ```typescript
   // 1. 添加性能监控
   const metrics = {
     loadTime: 0,
     errors: 0,
   };

   // 2. 实现灰度发布
   const shouldUseAsync = (userId: string) => {
     return userId % 100 < 20; // 20% 用户使用新实现
   };
   ```

4. **第四阶段：全面切换**
   ```typescript
   // 1. 移除旧实现
   // 2. 清理冗余代码
   // 3. 更新文档
   ```

### 国际化实现规范

1. **遵循静态生成**

   - 作为静态生成原则的具体实践
   - 在构建时生成所有语言版本
   - 避免客户端动态加载资源
   - 确保 SEO 友好

2. **路由结构**

   - 使用 Astro 官方推荐的动态路由方案
   - 采用 `src/pages/[lang]/` 目录结构
   - 通过动态路由参数处理语言切换
   - 保持 URL 结构清晰可预测
   - **示例**:
     ```
     src/pages/
     ├── [lang]/
     │   └── index.astro    # 处理 /{lang}/ 路由
     └── index.astro        # 处理根路由，重定向到默认语言
     ```

3. **翻译管理**

   - 将翻译文件模块化存储
   - 使用类型安全的翻译键
   - 提供默认语言回退机制
   - 确保翻译文件的完整性

4. **性能考虑**
   - 利用静态生成提升加载速度
   - 减少不必要的客户端 JavaScript
   - 优化静态资源的缓存策略
   - 确保良好的首次加载体验

### 最小必要条件

- 确保功能实现使用最少的依赖
- 保持代码简洁，避免不必要的抽象
- 优先使用内置功能，避免引入外部依赖
- **关键**: 在优化过程中不引入任何可能影响样式的改动

### Mobile-First Design（思维导向）

- 从移动端性能和体验角度思考代码优化
- 采用渐进增强的开发思维
- 确保基础功能在所有设备上可用
- **注意**: 这是指导思想，不涉及样式修改

## 开发环境设置

### 1. 包管理器迁移（不影响样式）

```bash
# 安装 pnpm
npm install -g pnpm

# 清理现有依赖
rm -rf node_modules
rm package-lock.json  # 如果使用 npm
rm yarn.lock         # 如果使用 yarn

# 安装依赖
pnpm install
```

### 2. 依赖清理（安全移除）

```bash
# 检查未使用的依赖
npx depcheck

# 仔细评估后再移除依赖
pnpm remove <package-name>
```

### 3. 项目结构（保持不变）

```
src/
├── components/      # 组件目录
│   └── sections/   # 页面区块组件
├── config/         # 配置文件
├── i18n/           # 国际化资源
│   └── translations/ # 翻译文件
├── pages/          # 页面文件
└── styles/         # 样式文件
```

## 项目优化指南

### 代码优化（不影响样式）

#### TypeScript 优化

- 使用严格的 TypeScript 配置
- 确保类型定义的准确性
- 移除未使用的类型定义和接口
- **注意**: 仅优化类型系统，不涉及运行时行为

#### Astro 组件优化（保持样式不变）

- 组件职责单一
- 适当使用组件复用
- 优化组件间的数据流动
- 利用 Astro 的 Islands 架构实现部分水合
- **重要**: 确保组件重构不影响渲染结果

#### 代码审查和优化（安全优化）

- 静态代码分析
  - ESLint 配置优化（不包含样式规则）
  - Prettier 代码格式化（保持样式相关代码不变）
  - TypeScript 类型检查
- 代码重构
  - 识别并移除重复的业务逻辑
  - 提取共用逻辑到工具函数
  - **注意**: 不重构任何样式相关代码

## Mobile-First 思维优化

### 性能优化思维（不改变样式）

- 优化数据处理逻辑
- 减少不必要的计算
- 优化事件处理程序
- **关键**: 只优化逻辑层面，不触及样式

### 条件渲染优化

- 优化组件加载逻辑
- 实现更智能的数据预加载
- **注意**: 确保优化不影响页面布局

## 性能优化

### 构建优化（不影响样式）

- 代码分割
  - 路由级别分割
  - 组件级别分割
  - 动态导入优化
- Tree Shaking
  - 移除未使用的业务代码
  - 优化依赖引入
- 资源压缩
  - JavaScript 压缩
  - 图片压缩（不改变尺寸和质量）
  - HTML 压缩

### 缓存策略（部署优化）

- 静态资源缓存
  - 设置适当的缓存头
  - 使用版本化文件名
- CDN 优化
  - 选择合适的 CDN 服务
  - 配置 CDN 缓存规则

## 测试和监控

### 回归测试（确保样式不变）

- 视觉回归测试
  - 对比优化前后的页面展现
  - 确保样式完全一致
- 功能测试
  - 验证所有功能正常
  - 检查交互行为一致性

### 性能测试

- Lighthouse 审计
  - 性能指标
  - 可访问性（不修改现有实现）
  - 最佳实践
- Web Vitals 监控
  - LCP (Largest Contentful Paint)
  - FID (First Input Delay)
  - CLS (Cumulative Layout Shift)

### 错误监控

- 前端错误捕获
- 性能指标监控
- 用户行为分析

## 开发流程

### 代码提交规范

- 遵循 Conventional Commits
  - feat: 新功能（不涉及样式）
  - fix: 修复（不影响展现）
  - perf: 性能优化（保持样式）
  - refactor: 重构（确保视觉一致）
- 每次提交前进行视觉回归测试

### 代码审查清单

- [ ] TypeScript 类型检查通过
- [ ] 代码风格符合项目规范
- [ ] 移除了未使用的代码
- [ ] 确保没有样式变更
- [ ] 性能指标符合要求
- [ ] 组件复用性检查
- [ ] i18n 文本检查
- [ ] 视觉回归测试通过

## 注意事项

1. 严格保持项目现有目录结构
2. 不得修改任何样式相关代码
3. 持续进行性能优化（仅限逻辑层面）
4. 定期清理未使用代码（安全移除）
5. 保持依赖的最小化
6. 确保国际化支持
7. 维护文档的及时更新
8. 遵循 Git 工作流规范
9. 每次更改后进行视觉回归测试
10. 优化重点在于代码质量和性能，而非视觉效果
